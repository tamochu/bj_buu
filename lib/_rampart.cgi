#================================================
# é•ÇƒVƒXƒeƒ€ Created by nanamie
#================================================

# require './lib/_rampart.cgi'; # é•Ç

$dom_barrier_ratio = 0.25; # “à­ŠÔ4•ª–ˆ‚É1%‰ñ•œ
$mil_barrier_ratio = 0.125; # ‘Ò•šŠÔ8•ª–ˆ‚É1%‰ñ•œ

# é•Ç’l‚Ì’è‹`
@barrier = (
# ‰Šú’l‚ÆãŒÀ’l
	[100, 100], # ’Êíî¨
	[200, 300], # ˆÃ•î¨ vs_npc.cgi ‚Å‚±‚ê‚¾‚¯’¼ÚQÆ‚³‚ê‚é
	[100, 200], # “S•Çî¨
);

#================================================
# é•Ç‰Šú’l‚ğæ“¾
#================================================
sub get_init_barrier {
	my $init_v = 0;
	if ($w{world} eq '7' || ($w{world} eq '19' && $w{world_sub} eq '7')) { $init_v = $barrier[2][0]; } # “S•Ç
#	elsif ($w{world} eq $#world_states && $m{country} eq $w{country}) { $init_v = $barrier[1][0]; } # ˆÃ•‘¤
	else { $init_v = $barrier[0][0]; } # ’ÊíEÕ‚èî¨E••ˆó‘¤
	return $init_v;
}

#================================================
# é•ÇãŒÀ’l‚ğæ“¾
#================================================
sub get_max_barrier {
	my $max_v = 0;
	if ($w{world} eq '7' || ($w{world} eq '19' && $w{world_sub} eq '7')) { $max_v = $barrier[2][1]; } # “S•Ç
	elsif ($w{world} eq $#world_states && $m{country} eq $w{country}) { $max_v = $barrier[1][1]; } # ˆÃ•‘¤ ãŒÀ’l‚ğ•K—v‚Æ‚·‚é‚Ì‚Í©‘‚Ì‚İ‚È‚Ì‚Å $m{country}
	else { $max_v = $barrier[0][1]; } # ’ÊíEÕ‚èî¨E••ˆó‘¤
	return $max_v;
}

#================================================
# w’è‚µ‚½‘‚Ìé•Ç’l‚ğæ“¾
#================================================
sub get_barrier {
	my $c = shift;
	return $cs{barrier}[$c];
}

#================================================
# w’è‚µ‚½‘‚Ìé•Ç’l‚ğ‘Œ¸
#================================================
sub change_barrier {
	my ($c, $v) = @_;
	my $max_value = &get_max_barrier;
	$cs{barrier}[$c] += int($v);
	$cs{barrier}[$c] = ($cs{barrier}[$c] < 0) ? 0 : ($cs{barrier}[$c] > $max_value) ? $max_value : $cs{barrier}[$c];
}

#================================================
# “à­‚É‚æ‚éé•ÇC•œ
# „¬‹K–Í3%A’†‹K–Í5%A‘å‹K–Í10%B’·‹K–Í‚à•ª”*0.25‚Ã‚Â‰ñ•œB
# ‚Â‚Ü‚èS‘©ŠÔ * 0.25 ‚¾‚¯ã¸
#================================================
sub gain_dom_barrier {
	my $v = shift;
	&change_barrier($m{country}, $v * $dom_barrier_ratio);
}

#================================================
# ‘Ò‚¿•š‚¹‚É‚æ‚éé•ÇC•œ
# „20%+20•ª‚ğ’´‚¦‚½•ª”*0.25B
# 20 * 1 + (S‘©ŠÔ - 20) * 0.25A‚Â‚Ü‚èÅ‚ 135 %‰ñ•œ
# “à­‚É”ä‚×‚ÄŒø—¦‚ª—Ç‚¢ —áF“à­4ŠÔ‚Å 60 %‚É‘Î‚µ‚Ä‘Ò•š4ŠÔ‚Å 75 %A‘Ò•š8ŠÔ‚Å 135 %
# ƒeƒXƒg‚·‚é‚Ü‚Å‚à‚È‚¢‚®‚ç‚¢ã‚ª‚è‚·‚¬‚È‹C‚µ‚©‚µ‚È‚¢‚Ì‚Å‚Ş‚µ‚ë“à­‚æ‚è‚à—}‚¦‚Ä S‘©ŠÔ * 0.125¨‘Ò•š8ŠÔ‚Å 60% “à­4ŠÔ‚Æ“¯‚¶
#================================================
sub gain_mil_barrier {
	my $is_start = shift;

	if ($is_start eq '1') {
		open my $fh, "> $userdir/$id/ambush_time.cgi";
		print $fh $time;
		close $fh;
	}
	else {
		if (!-f "$userdir/$id/ambush_time.cgi") {
			open my $fh, "> $userdir/$id/ambush_time.cgi";
			print $fh $time;
			close $fh;
		}

		open my $fh, "< $userdir/$id/ambush_time.cgi" or &error("ambush_time.cgiÌ§²Ù‚ªŠJ‚¯‚Ü‚¹‚ñ");;
		my $line = <$fh>;
		close $fh;

		my $v = ($time - $line) * $mil_barrier_ratio / 60;
		$v = $v > 60 ? 60 : $v; # Å‚60% ’´’·Šú“à­‚Æ“¯‚¶’l
		&change_barrier($m{country}, $v);
	}
}

#================================================
# w’è‚µ‚½‘‚Ìé•Ç‚É‚æ‚é’D‘—Í‚Æ’D‘ãŒÀ‚Ì•â³‚ª”z—ñ‚Å•Ô‚é
#================================================
sub get_rampart_modify {
	my $c = shift;
	my $yb = &get_barrier($c);

	my ($v, $vv) = 
			($yb <= 5)  ? (1.4,  400) : # 0`5		’D‘—Í1.4	’D‘ãŒÀ+400
			($yb <= 10) ? (1.3,  400) : # 6`10		’D‘—Í1.3	’D‘ãŒÀ+400
			($yb <= 20) ? (1.25, 300) : # 11`20	’D‘—Í1.25	’D‘ãŒÀ+300
			($yb <= 30) ? (1.2,  300) : # 21`30	’D‘—Í1.2	’D‘ãŒÀ+300
			($yb <= 40) ? (1.15, 200) : # 31`40	’D‘—Í1.15	’D‘ãŒÀ+200
			($yb <= 50) ? (1.1,  200) : # 41`50	’D‘—Í1.1	’D‘ãŒÀ+200
			($yb <= 70) ? (1.0,  100) : # 51`70	’D‘—Í1.0	’D‘ãŒÀ+100
			($yb <  90) ? (1.0,  0)   : # 71`89	’D‘—Í1.0	’D‘ãŒÀ+0
			($yb < 120) ? (0.9,  0)   : # 90`119	’D‘—Í0.9	’D‘ãŒÀ+0
			($yb < 150) ? (0.85, 0)   : # 120`149	’D‘—Í0.85	’D‘ãŒÀ+0
			($yb < 180) ? (0.8,  -50) : # 150`179	’D‘—Í0.8	’D‘ãŒÀ-50
			($yb < 200) ? (0.7,  -50) : # 180`199	’D‘—Í0.7	’D‘ãŒÀ-50
			($yb < 230) ? (0.6, -100) : # 200`229	’D‘—Í0.6	’D‘ãŒÀ-100
			($yb < 250) ? (0.5, -100) : # 230`249	’D‘—Í0.5	’D‘ãŒÀ-100
							  (0.4, -150) ; # 250`		’D‘—Í0.4	’D‘ãŒÀ-150
	return ($v, $vv);
}

1;

